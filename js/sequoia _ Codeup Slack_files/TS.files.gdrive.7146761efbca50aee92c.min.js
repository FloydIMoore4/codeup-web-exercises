webpackJsonp([266],{1635:function(e,t){(function(){TS.registerModule("files.gdrive",{onStart:function e(){if(!TS.client)return;TS.files.team_file_shared_sig.add(S)},openPickerWindow:function t(){var r=null;return new Promise(function(t,a){var l=TS.utility.window.open({url:e,try_window_open_in_ssb:true,height:n});if(!l)a(new Error("could not open window"));r=o(t,a);window.addEventListener("message",r);if(i)a("Promise already made");i=true}).then(function(e){i=false;return c(e.chosen_files,TS.shared.getActiveModelOb())}).catch(function(e){if("Promise already made"===e)return;var t=a;var r=TS.shared.getActiveModelOb();TS.error(e);if(("unidentified_external_url"===e.data.error||"file_type_has_no_handler"===e.data.error)&&e.args.link){t=TS.i18n.t("We don’t currently support importing that type of Google Drive file, but we included the link so that others can access it.","files")();v(r.id,e.args.link)}if("filename_too_long"===e.data.error)t=l;TS.client.ui.addEphemeralBotMsg({text:t,ephemeral_type:"file_type_has_no_handler",slackbot_feels:"sad_surprise"});i=false}).finally(function(){window.removeEventListener("message",r)})},createAndShare:function e(t,r){return m(t,r).then(function(e){TS.files.gdrive.create(t,e)}).catch(function(){TS.menu.file.onGDriveCreateComplete(false)})},create:function e(t,n){if(n&&n.channel){var i=TS.shared.getModelObById(n.channel);if(i.is_channel)TS.channels.displayChannel({id:i.id});else if(i.is_mpim)TS.mpims.displayMpim({id:i.id});else if(i.is_group)TS.groups.displayGroup({id:i.id});else if(TS.ims.getImByMemberId(n.channel))TS.ims.startImByMemberId(n.channel);else TS.error("no valid shared channel/im/mpim/group to display")}return TS.api.call("files.createExternal",{service_stub:"gdrive",mime_type:r+"."+t,filename:n.title||"",open_edit:!!n.channel}).then(function(e){TS.utility.window.alwaysOpenInBrowser(e.data.url);if(n&&n.channel)p(e.data.url,n.channel,n.comment);TS.menu.file.onGDriveCreateComplete(true,e)}).catch(function(e){TS.menu.file.onGDriveCreateComplete(false);var r=a;if("use_auth_url"===e.data.error)return d(t,n);if("filename_too_long"===e.data.error)r=l;TS.error(e);TS.client.ui.addEphemeralBotMsg({text:r,ephemeral_type:"unhandled_gdrive_create",slackbot_feels:"sad_surprise"})})}});var e=TS.boot_data.team_url+"files/import/gdrive";var t=TS.boot_data.team_url+"files/create/gdrive/auth";var r="application/vnd.google-apps";var n=675;var i=false;var a=TS.i18n.t("Darn, that didn’t work. Try again or <https://my.slack.com/help/requests/new|contact us> if it’s still not working.","files")();var l=TS.i18n.t("Sorry! The name of that file is too long for us to handle. Please try importing a file with a shorter filename.","files")();var o=function e(t,r){return u({resolve:t,reject:r,method:"gdrive_picker"})};var s=function e(t,r){return u({resolve:t,reject:r,method:"google_auth"})};var u=function e(t){return function(e){if(e.data.method!==t.method)return;if(!e.data.ok)t.reject(new Error(t.method+" not ok"));else t.resolve(e.data)}};var c=function e(t,r){var n=t.map(function(e){return f(e,r)});return Promise.all(n)};var f=function e(t,r){return TS.api.call("files.uploadExternal",{channels:r.id,link:t.url}).then(function(e){if(r.user&&TS.ims.getImByMemberId(r.user)&&TS.model.team.enterprise_id)v(r.id,e.data.file.url_private,true,true)})};var d=function e(r,i){var a=null;return new Promise(function(e,r){var i=TS.utility.window.open({url:t,try_window_open_in_ssb:true,height:n});if(!i)r(new Error("could not open window"));a=s(e,r);window.addEventListener("message",a)}).then(function(){return TS.files.gdrive.create(r,i)}).catch(function(e){TS.error(e)}).finally(function(){window.removeEventListener("message",a)})};var m=function e(t,n){return new Promise(function(e,i){var a={type:r+t,display_type:n};var l=TS.templates.builders.buildFileSharingControls(a,false,false,true,null);var o=void 0;if("Document"===n)o=TS.i18n.t("Create a Google Document","files")();else if("Presentation"===n)o=TS.i18n.t("Create a Google Presentation","files")();else if("Spreadsheet"===n)o=TS.i18n.t("Create a Google Spreadsheet","files")();else o=TS.i18n.t("Create a Google file","files")();TS.generic_dialog.start({title:o,body:TS.templates.gdrive_create_dialog({sharing_html:new Handlebars.SafeString(l)}),show_cancel_button:true,esc_for_ok:false,fullscreen:false,go_button_text:TS.i18n.t("Create","files")(),type:"overflow_visible",onGo:function t(){e(h())},onCancel:i});$("#share_cb").removeAttr("checked");TS.ui.file_share.bindFileShareDropdowns();TS.ui.file_share.bindFileShareShareToggle();TS.ui.file_share.bindFileShareCommentField();TS.ui.comments.bindInput($("#file_comment_textarea"),function(){e(h)})})};var h=function e(){var t=_.trim(TS.utility.contenteditable.value($("#file_comment_textarea")));t=TS.utility.contenteditable.synchronouslyReplacePotentialMentions(t,{complete_member_specials:false});return{title:_.trim($("#document_title").val())||TS.i18n.t("Untitled","files")(),comment:t,channel:$("#share_cb").is(":checked")?$("#share_model_ob_id").val():false}};var p=function e(t,r,n){var i=false;if(TS.ims.getImByMemberId(r))i=true;return TS.api.call("files.uploadExternal",{link:t,channels:i?"":r}).then(function(e){if(i)v(r,e.data.file.url_private,true,true);if(n)TS.api.call("files.comments.add",{file:e.data.file.id,comment:n,channel:r})}).catch(function(e){TS.error(e);TS.client.ui.addEphemeralBotMsg({text:TS.i18n.t("Oh no! I couldn’t import your newly created file","files")(),ephemeral_type:"gdrive_share_file_error",slackbot_feels:"sad_surprise"})})};var v=function e(t,r,n,i){TS.api.call("chat.postMessage",{channel:t,text:r,unfurl_links:n||false,unfurl_media:i||false}).catch(function(e){TS.error(e)})};var S=function e(t){if("gdrive"!==_.get(t,"external_type"))return;if(_.get(t,"user")!==TS.model.user.id)return;if(!TS.prefs.getTeamPref("gdrive_enabled_team"))return;if(TS.prefs.getPref("seen_gdrive_coachmark"))return;TS.coachmark.start(TS.coachmarks.coachmarks.gdrive);TS.prefs.setPref("seen_gdrive_coachmark",true);TS.prefs.setPrefByAPI({name:"seen_gdrive_coachmark",value:true})}})()}},[1635]);